{% extends "base.html" %}

{% block content %}
<style>
    /* --- MAP GRID STYLES --- */
    .map-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    .map-card {
        background: #2a2a2a;
        border: 2px solid #444;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        cursor: pointer;
        transition: transform 0.2s, border-color 0.2s;
        padding: 0;
        width: 100%;
    }
    .map-card:hover:not(:disabled) {
        transform: scale(1.05);
        border-color: #fff;
    }
    .map-image {
        width: 100%; height: 100px; object-fit: cover; display: block;
    }
    .map-name {
        padding: 8px; text-align: center; font-weight: bold; color: white;
        background: rgba(0,0,0,0.8); position: absolute; bottom: 0; width: 100%;
    }

    /* STATES: BANNED */
    .is-banned {
        filter: grayscale(100%); border-color: #5a1a1a; cursor: not-allowed; opacity: 0.6;
    }
    .banned-overlay {
        position: absolute; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 10;
    }
    .banned-text {
        color: #ff4444; border: 3px solid #ff4444; padding: 5px 15px;
        font-weight: 900; transform: rotate(-15deg); font-size: 1.2rem;
    }
    /* Klasse um Overlay sichtbar zu machen */
    .is-banned .banned-overlay { display: flex; }

    /* STATES: PICKED */
    .is-picked {
        border-color: #2e7d32; box-shadow: 0 0 10px #2e7d32; cursor: not-allowed;
    }
    .picked-badge {
        position: absolute; top: 5px; right: 5px;
        background: #2e7d32; color: white; padding: 2px 6px; border-radius: 4px; 
        font-weight: bold; font-size: 0.8rem; display: none;
    }
    /* Klasse um Badge sichtbar zu machen */
    .is-picked .picked-badge { display: block; }

    /* CHAT */
    .chat-container { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; margin-top: 30px; display: flex; flex-direction: column; height: 400px; }
</style>

<div class="container" style="max-width: 1100px; margin: 0 auto;">

    <div class="card" style="margin-bottom: 20px; text-align: center; padding: 25px; border-left: 8px solid #fbc02d;" id="statusCard">
        <h2 style="margin: 0;" id="statusHeadline">
            Lade Status...
        </h2>
    </div>

    <div id="votingSection">
        <form method="POST">
            <div class="map-grid">
                {% for map in all_maps %}
                    <button type="submit" name="selected_map" value="{{ map.name }}" 
                            id="btn-map-{{ map.name|replace(' ', '-') }}"
                            class="map-card">
                        
                        <img src="{{ url_for('static', filename='map_images/' + map.image_file) }}" class="map-image">
                        <div class="map-name">{{ map.name }}</div>

                        <div class="banned-overlay"><div class="banned-text">BANNED</div></div>
                        <div class="picked-badge">PICKED</div>
                    </button>
                {% endfor %}
            </div>
        </form>
        <div id="waitMessage" style="text-align: center; color: #aaa; margin-top: 10px; display: none;">
            ‚è≥ Gegner w√§hlt...
        </div>
    </div>

    <div id="scoringSection" class="card" style="display: none;">
        
        {% if current_user.is_admin or current_user.is_mod %}
        <div style="background: #252525; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between;">
            <strong>üîë Lobby Code:</strong> 
            <span id="lobbyCodeDisplay">{% if match.lobby_code %}{{ match.lobby_code }}{% else %}...{% endif %}</span>
        </div>
        {% endif %}

        <h3>Ergebnisse eintragen</h3>
        <form method="POST">
            <input type="hidden" name="submit_scores" value="true">
            <table style="width:100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead><tr style="border-bottom: 1px solid #555;"><th>Map</th><th>{{ match.team_a }}</th><th>{{ match.team_b }}</th></tr></thead>
                <tbody id="scoreTableBody">
                    {% set saved_a = match.get_scores_a() %}{% set saved_b = match.get_scores_b() %}
                    {% for i in range(1, 5) %}
                    <tr style="border-bottom: 1px solid #333;">
                        <td style="padding:10px;">
                            <small>Runde {{ i }}</small><br>
                            <strong class="map-slot-{{ i-1 }}">
                                {% if picked and picked|length >= i %}{{ picked[i-1] }}{% endif %}
                            </strong>
                        </td>
                        <td style="text-align:center;"><input type="number" name="score_a_{{ i }}" min="0" style="width:50px; text-align:center;" value="{{ saved_a[i-1] if saved_a|length >= i else 0 }}"></td>
                        <td style="text-align:center;"><input type="number" name="score_b_{{ i }}" min="0" style="width:50px; text-align:center;" value="{{ saved_b[i-1] if saved_b|length >= i else 0 }}"></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if not current_user.is_admin and not current_user.is_mod %}
            <div style="background: #252525; padding: 15px; border-radius: 4px; margin-bottom: 20px;">
                <h4 style="margin-top: 0; color: #00e676;">Wer hat gespielt? (Eigenes Line-up)</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                    {% for member in current_user.team_members %}
                    <label style="cursor: pointer; display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" name="lineup_member" value="{{ member.gamertag }}"> {{ member.gamertag }}
                    </label>
                    {% else %}
                        <div style="color: #aaa; font-style: italic;">Keine Spieler im Roster.</div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <button type="submit" class="btn" style="width:100%; background:#d32f2f;">Ergebnisse & Line-up Senden üì§</button>
        </form>
    </div>

    <div id="confirmSection" class="card" style="border-left: 5px solid #ff9800; display: none;">
        <h3 style="color: #ff9800;">Best√§tigung erforderlich</h3>
        <p id="confirmText">Gegner hat eingereicht. Bitte pr√ºfen.</p>
        
        <div style="background: #222; padding: 15px; margin-bottom: 20px;">
            <strong>Line-up des Gegners:</strong>
            <ul>
                {% if current_user.username == match.team_a %}
                    {% for p in match.get_draft_b_lineup() %}<li>{{ p }}</li>{% endfor %}
                {% else %}
                    {% for p in match.get_draft_a_lineup() %}<li>{{ p }}</li>{% endfor %}
                {% endif %}
            </ul>
        </div>

        <form method="POST">
            <button type="submit" name="confirm_lineup" value="true" class="btn" style="width: 100%; background: #4caf50; font-size: 1.2rem;">
                ‚úÖ Alles Korrekt - Best√§tigen
            </button>
        </form>
    </div>

    <div id="finishedSection" class="card" style="display: none; border-left: 5px solid #4caf50;">
        <h3 style="color: #4caf50;">üèÅ Match Beendet</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div style="background: #222; padding: 10px;">
                <strong style="color: #2196f3;">{{ match.team_a }}</strong>
                <ul>{% for p in match.get_lineup_a() %}<li>{{ p }}</li>{% endfor %}</ul>
            </div>
            <div style="background: #222; padding: 10px;">
                <strong style="color: #2196f3;">{{ match.team_b }}</strong>
                <ul>{% for p in match.get_lineup_b() %}<li>{{ p }}</li>{% endfor %}</ul>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div id="chatBox" style="flex: 1; overflow-y: auto; padding: 10px;"></div>
        <div style="display: flex; padding: 10px; border-top: 1px solid #333;">
            <input type="text" id="msgInput" style="flex: 1; padding: 10px; background: #222; border: none; color: white;" placeholder="Nachricht...">
            <button onclick="sendMsg()" class="btn-small">Senden</button>
        </div>
    </div>
</div>

<script>
    const matchId = {{ match.id }};
    const currentUser = "{{ current_user.username }}";
    const isAdmin = {{ 'true' if current_user.is_admin or current_user.is_mod else 'false' }};
    
    // Elemente
    const statusHeadline = document.getElementById('statusHeadline');
    const statusCard = document.getElementById('statusCard');
    const votingSec = document.getElementById('votingSection');
    const scoringSec = document.getElementById('scoringSection');
    const confirmSec = document.getElementById('confirmSection');
    const finishedSec = document.getElementById('finishedSection');
    const waitMsg = document.getElementById('waitMessage');
    const lobbyDisplay = document.getElementById('lobbyCodeDisplay');

    // --- LIVE STATE UPDATE ---
    async function updateState() {
        try {
            const res = await fetch(`/api/league_match/${matchId}/state`);
            const data = await res.json();
            
            // 1. UPDATE HEADER & SECTIONS
            updateHeaderAndSections(data);

            // 2. UPDATE MAP GRID (Nur wenn in Ban/Pick Phase)
            if (data.state.includes('ban') || data.state.includes('pick')) {
                updateMapGrid(data);
            }

            // 3. UPDATE SCORE TABLE MAP NAMES
            if (data.picked.length > 0) {
                data.picked.forEach((mapName, index) => {
                    const slot = document.querySelector(`.map-slot-${index}`);
                    if(slot) slot.innerText = mapName;
                });
            }

            // 4. LOBBY CODE
            if (lobbyDisplay) lobbyDisplay.innerText = data.lobby_code ? data.lobby_code : "...";

        } catch (e) { console.error("Poll Error", e); }
    }

    function updateHeaderAndSections(data) {
        let text = "";
        let color = "#fbc02d";
        const state = data.state;

        // Sichtbarkeit resetten
        votingSec.style.display = 'none';
        scoringSec.style.display = 'none';
        confirmSec.style.display = 'none';
        finishedSec.style.display = 'none';

        if (state.includes('ban')) {
            text = `üö´ BANN: ${data.active_team}`;
            color = "#d32f2f";
            votingSec.style.display = 'block';
        } 
        else if (state.includes('pick')) {
            text = `‚úÖ PICK: ${data.active_team}`;
            color = "#1976d2";
            votingSec.style.display = 'block';
        } 
        else if (['scoring_phase', 'conflict', 'waiting_for_confirmation'].includes(state)) {
            text = "üìù Ergebnisse eintragen";
            if (state === 'conflict') { text = "‚ö†Ô∏è KONFLIKT"; color = "#ff5252"; }
            if (state === 'waiting_for_confirmation') text = "‚è≥ Warte auf Gegner...";
            scoringSec.style.display = 'block';
        }
        else if (state === 'confirming') {
            text = "üëÄ Best√§tigung des Gegners n√∂tig";
            color = "#ff9800";
            confirmSec.style.display = 'block';
            
            // Check ob ich schon best√§tigt habe
            const iAmA = (currentUser === "{{ match.team_a }}");
            const iHaveConfirmed = (iAmA && data.confirmed_a) || (!iAmA && data.confirmed_b);
            
            const confirmText = document.getElementById('confirmText');
            const btn = confirmSec.querySelector('button');
            
            if (iHaveConfirmed) {
                confirmText.innerText = "‚úÖ Du hast best√§tigt. Warte auf den Gegner.";
                confirmText.style.color = "#4caf50";
                if(btn) btn.style.display = 'none';
            } else {
                confirmText.innerText = "Gegner hat eingereicht. Bitte pr√ºfen.";
                confirmText.style.color = "white";
                if(btn) btn.style.display = 'block';
            }
        }
        else if (state === 'finished') {
            text = "üèÅ Match Beendet";
            color = "#4caf50";
            finishedSec.style.display = 'block';
        }

        statusHeadline.innerText = text;
        statusCard.style.borderLeftColor = color;
    }

    function updateMapGrid(data) {
        // Welches Team ist dran?
        const amIActive = (data.active_team === currentUser) || isAdmin;
        
        waitMsg.style.display = amIActive ? 'none' : 'block';

        const buttons = document.querySelectorAll('button[name="selected_map"]');
        buttons.forEach(btn => {
            const mapName = btn.value;
            const isBanned = data.banned.includes(mapName);
            const isPicked = data.picked.includes(mapName);

            // Klassen resetten
            btn.classList.remove('is-banned', 'is-picked');
            
            if (isBanned) btn.classList.add('is-banned');
            if (isPicked) btn.classList.add('is-picked');

            // Disabled Logik: Wenn Karte weg ist ODER ich nicht dran bin
            btn.disabled = isBanned || isPicked || !amIActive;
        });
    }

    // --- CHAT ---
    const chatBox = document.getElementById('chatBox');
    const msgInput = document.getElementById('msgInput');

    async function sendMsg() {
        const txt = msgInput.value; if(!txt) return;
        await fetch(`/api/league_match/${matchId}/chat`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({message: txt}) });
        msgInput.value = ''; loadChat();
    }

    async function loadChat() {
        try {
            const res = await fetch(`/api/league_match/${matchId}/chat`);
            const data = await res.json();
            chatBox.innerHTML = data.map(m => {
                let badge = m.is_admin ? 'üõ°Ô∏è ' : (m.is_mod ? 'üõ°Ô∏è ' : '');
                let color = m.is_admin ? '#e65100' : (m.is_mod ? '#00bcd4' : '#333');
                return `<div style="margin-bottom: 5px; text-align: ${m.is_me ? 'right':'left'}"><span style="font-size: 0.7em; color: #888;">${badge}${m.user}</span><br><span style="background: ${m.is_me ? '#1976d2' : color}; padding: 5px 10px; border-radius: 4px; display: inline-block; color: white;">${m.text}</span></div>`;
            }).join('');
        } catch(e) {}
    }

    // Intervalle starten
    setInterval(() => {
        updateState();
        loadChat();
    }, 2000);
    
    // Initial laden
    updateState();
    loadChat();
</script>
{% endblock %}