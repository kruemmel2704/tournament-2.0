{% extends "base.html" %}

{% block content %}
<style>
    /* Karten Styles */
    .map-container { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; }
    .map-box { min-width: 140px; background: #2a2a2a; border: 2px solid #444; border-radius: 8px; overflow: hidden; text-align: center; }
    .map-img { width: 100%; height: 80px; object-fit: cover; }
    .map-title { padding: 5px; font-weight: bold; font-size: 0.9rem; color: #fff; }
    
    /* Chat */
    .chat-container { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; margin-top: 30px; display: flex; flex-direction: column; height: 400px; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
    .message-bubble { max-width: 80%; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; position: relative; word-wrap: break-word; }
    .msg-own { align-self: flex-end; background: #1976d2; color: white; border-bottom-right-radius: 2px; }
    .msg-other { align-self: flex-start; background: #333; color: #ddd; border-bottom-left-radius: 2px; }
    .msg-admin { border: 1px solid #ff9800; background: #3a2000; } 
    .msg-mod { border: 1px solid #00bcd4; background: #00333d; }
    .msg-meta { font-size: 0.7em; opacity: 0.7; margin-bottom: 2px; display: block; }
</style>

<div class="container" style="max-width: 1000px; margin: 0 auto;">
    
    <div class="card" style="margin-bottom: 20px; text-align: center; padding: 25px; border-left: 8px solid #fbc02d;" id="statusCard">
        <h2 style="margin: 0;">{{ match.team_a }} <span style="color:#aaa">VS</span> {{ match.team_b }}</h2>
        <div style="margin-top: 10px; font-weight: bold; color: #9c27b0;" id="statusDisplay">
            STATUS: {{ match.state|upper|replace('_', ' ') }}
        </div>
    </div>

    {% if (current_user.is_admin or current_user.is_mod) and match.state == 'waiting_for_ready' %}
    <div class="card" style="border-left: 5px solid #2196f3; margin-bottom: 20px;">
        <h3 style="color: #2196f3; margin-top: 0;">üó∫Ô∏è Admin: 3 Karten festlegen</h3>
        <form method="POST">
            <input type="hidden" name="set_maps" value="true">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                {% for i in range(1, 4) %}
                <div>
                    <label style="display:block; margin-bottom:5px;">Karte {{ i }}</label>
                    <select name="map_{{ i }}" style="width: 100%; padding: 8px; background: #333; color: white; border: 1px solid #555; border-radius: 4px;">
                        {% for map in all_maps %}
                            <option value="{{ map.name }}">{{ map.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}
            </div>
            <button class="btn" style="width: 100%; background: #2196f3; margin-top: 15px;">Karten speichern & weiter</button>
        </form>
    </div>
    {% endif %}

    {% if picked %}
    <div class="card" style="margin-bottom: 20px;">
        <h4>üèüÔ∏è Zu spielende Karten:</h4>
        <div class="map-container">
            {% for m_name in picked %}
                {% set map_obj = all_maps | selectattr('name', 'equalto', m_name) | first %}
                <div class="map-box">
                    {% if map_obj %}
                        <img src="{{ url_for('static', filename='map_images/' + map_obj.image_file) }}" class="map-img">
                    {% endif %}
                    <div class="map-title">{{ loop.index }}. {{ m_name }}</div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if match.state in ['waiting_for_code', 'in_progress', 'finished'] %}
    <div class="card" style="text-align: center; border: 2px solid #ff9800; margin-bottom: 20px;">
        <h3>üîë LOBBY CODE</h3>
        <div id="lobbyCodeDisplay" style="font-size: 2.5rem; letter-spacing: 5px; font-weight: bold; color: #ff9800; margin: 15px 0;">
            {% if match.lobby_code %}{{ match.lobby_code }}{% else %}...{% endif %}
        </div>
        
        {% if current_user.is_admin or current_user.is_mod %}
            <form method="POST" style="margin-top: 10px; display: flex; justify-content: center; gap: 10px;">
                <input type="text" name="lobby_code" placeholder="Code eingeben" value="{{ match.lobby_code or '' }}" style="padding: 10px; background: #222; border: 1px solid #555; color: white; width: 200px;">
                <button name="set_lobby_code" class="btn-small">Senden & Start</button>
            </form>
        {% else %}
            {% if not match.lobby_code %}<div style="color: #aaa;">Warte auf Admin...</div>{% endif %}
        {% endif %}
    </div>
    {% endif %}

    {% if (current_user.is_admin or current_user.is_mod) and match.state in ['in_progress', 'finished'] %}
    <div class="card" style="border-left: 5px solid #f44336; margin-bottom: 20px;">
        <h3 style="color: #f44336; margin-top: 0;">üëÆ Ergebnisse eintragen</h3>
        <form method="POST">
            <input type="hidden" name="submit_scores" value="true">
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="border-bottom: 1px solid #555;">
                        <th style="text-align: left; padding: 10px;">Map</th>
                        <th style="text-align: center;">{{ match.team_a }}</th>
                        <th style="text-align: center;">{{ match.team_b }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% set saved_a = match.get_scores_a() %}
                    {% set saved_b = match.get_scores_b() %}
                    {% for i in range(1, 4) %}
                    <tr style="border-bottom: 1px solid #333;">
                        <td style="padding: 10px;">
                            <span style="color:#888;">Map {{ i }}</span><br>
                            {% if picked and picked|length >= i %}<strong>{{ picked[i-1] }}</strong>{% endif %}
                        </td>
                        <td style="text-align: center;">
                            <input type="number" name="score_a_{{i}}" style="width: 60px; text-align: center; padding: 5px; background: #222; color: white; border: 1px solid #555;" 
                                   value="{{ saved_a[i-1] if saved_a|length >= i else 0 }}">
                        </td>
                        <td style="text-align: center;">
                            <input type="number" name="score_b_{{i}}" style="width: 60px; text-align: center; padding: 5px; background: #222; color: white; border: 1px solid #555;" 
                                   value="{{ saved_b[i-1] if saved_b|length >= i else 0 }}">
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <button class="btn" style="width: 100%; background: #f44336;">Ergebnisse Speichern & Beenden</button>
        </form>
    </div>
    {% endif %}

    <div class="chat-container">
        <div style="padding: 10px; border-bottom: 1px solid #333; font-weight: bold; background: #252525;">üí¨ Cup Chat</div>
        <div id="chatBox" class="chat-messages">
            <div style="text-align: center; color: #555; margin-top: 20px;">Lade Chat...</div>
        </div>
        <div style="padding: 10px; border-top: 1px solid #333; display: flex; gap: 10px; background: #222;">
            <input type="text" id="msgInput" style="flex: 1; padding: 10px; background: #111; border: 1px solid #444; color: white; border-radius: 4px;" placeholder="Nachricht..." onkeypress="handleEnter(event)">
            <button onclick="sendMsg()" class="btn-small" style="background: #4caf50;">Senden</button>
        </div>
    </div>

</div>

<script>
    const matchId = {{ match.id }};
    const currentUser = "{{ current_user.username }}";
    
    const chatBox = document.getElementById('chatBox');
    const lobbyDisplay = document.getElementById('lobbyCodeDisplay');
    const statusDisplay = document.getElementById('statusDisplay');
    let lastMsgCount = 0;

    // --- STATE UPDATE (Live Status & Lobby Code f√ºr User) ---
    async function updateState() {
        try {
            // WICHTIG: Hier auf /api/cup_match/... zugreifen!
            const res = await fetch(`/api/cup_match/${matchId}/state`);
            const data = await res.json();
            
            // Status Text Update
            statusDisplay.innerText = "STATUS: " + data.state.toUpperCase().replace('_', ' ');
            
            // Lobby Code Update (nur Textanzeige, Input ist Formular)
            if (lobbyDisplay) {
                lobbyDisplay.innerText = data.lobby_code ? data.lobby_code : (data.state === 'waiting_for_code' ? "Warten auf Admin..." : "...");
            }

            // Auto-Reload bei Phasenwechsel (damit User neue Maps/Inputs sehen)
            // Wenn im Backend 'in_progress', aber im Frontend noch kein Lobby-Code-Feld da ist -> Reload
            const currentState = "{{ match.state }}";
            if (data.state !== currentState) {
                // Einfacher Reload bei Status√§nderung, um UI sauber neu zu bauen
                window.location.reload();
            }

        } catch (e) { console.log("Polling error:", e); }
    }

    // --- CHAT FUNKTIONEN ---
    async function sendMsg() {
        const txt = document.getElementById('msgInput').value;
        if(!txt) return;
        // WICHTIG: /api/cup_match/...
        await fetch(`/api/cup_match/${matchId}/chat`, { 
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify({message: txt}) 
        });
        document.getElementById('msgInput').value = ''; 
        loadChat();
    }

    function handleEnter(e) { if(e.key === 'Enter') sendMsg(); }

    async function loadChat() {
        try {
            // WICHTIG: /api/cup_match/...
            const res = await fetch(`/api/cup_match/${matchId}/chat`);
            const data = await res.json();
            
            if (data.length !== lastMsgCount) {
                chatBox.innerHTML = data.map(m => {
                    let badge = '';
                    let color = '#333'; // Standard Grau
                    if (m.is_admin) { badge = 'üõ°Ô∏è '; color = '#e65100'; } // Orange
                    else if (m.is_mod) { badge = 'üõ°Ô∏è '; color = '#00bcd4'; } // Cyan

                    return `<div style="margin-bottom: 8px; text-align: ${m.is_me ? 'right':'left'}">
                        <span class="msg-meta">${badge}${m.user} ‚Ä¢ ${m.time}</span>
                        <div style="background: ${m.is_me ? '#1976d2' : color}; padding: 6px 12px; border-radius: 6px; display: inline-block; color: white; border: ${m.is_me ? 'none' : '1px solid #444'};">
                            ${m.text}
                        </div>
                    </div>`;
                }).join('');
                
                chatBox.scrollTop = chatBox.scrollHeight;
                lastMsgCount = data.length;
            }
        } catch(e) {}
    }

    // Intervalle starten
    setInterval(() => { updateState(); loadChat(); }, 3000);
    // Initial laden
    updateState(); loadChat();
</script>
{% endblock %}