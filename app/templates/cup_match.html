{% extends "base.html" %}

{% block content %}
<style>
    /* --- PWA / MOBILE STYLES --- */
    .map-container { 
        display: flex; gap: 15px; overflow-x: auto; padding-bottom: 15px; margin-bottom: 20px;
        -webkit-overflow-scrolling: touch; scroll-snap-type: x mandatory;
    }
    .map-box { 
        min-width: 140px; flex: 0 0 auto; background: #2a2a2a; border: 2px solid #444; 
        border-radius: 8px; overflow: hidden; text-align: center; scroll-snap-align: start;
    }
    .map-img { width: 100%; height: 80px; object-fit: cover; }
    .map-title { padding: 8px; font-weight: bold; font-size: 0.9rem; color: #fff; }
    
    .admin-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }

    /* Chat Anpassung */
    .chat-container { 
        background: #1a1a1a; border: 1px solid #333; border-radius: 8px; margin-top: 20px; 
        display: flex; flex-direction: column; height: 50vh; 
    }
    .chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #151515; }
    .msg-meta { font-size: 0.7em; opacity: 0.7; margin-bottom: 4px; display: block; color: #aaa; }

    /* Inputs f√ºr Touch optimieren */
    input, select, button { font-size: 16px !important; }

    /* CLAN HEADER STYLES */
    .team-display { display: flex; flex-direction: column; align-items: center; }
    .clan-sub { font-size: 0.9rem; color: #aaa; font-weight: normal; margin-top: 2px; }
    .vs-text { margin: 0 15px; color: #666; font-size: 1.2rem; align-self: center; }

    @media (max-width: 768px) {
        .admin-grid { grid-template-columns: 1fr; }
        .card { padding: 15px; }
        .mobile-full-width { width: 100% !important; }
        .lobby-form { flex-direction: column; }
        .lobby-form input { width: 100% !important; margin-bottom: 10px; }
    }
</style>

<div class="container" style="max-width: 1000px; margin: 0 auto;">
    
    <div class="card" style="margin-bottom: 20px; text-align: center; padding: 20px; border-left: 8px solid #fbc02d;" id="statusCard">
        
        <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 15px;">
            <div class="team-display">
                <span style="font-size: 1.4rem; font-weight: bold;">{{ match.team_a }}</span>
                {% if match.team_a_clan %}<span class="clan-sub">({{ match.team_a_clan }})</span>{% endif %}
            </div>
            
            <span class="vs-text">VS</span>
            
            <div class="team-display">
                <span style="font-size: 1.4rem; font-weight: bold;">{{ match.team_b }}</span>
                {% if match.team_b_clan %}<span class="clan-sub">({{ match.team_b_clan }})</span>{% endif %}
            </div>
        </div>

        <div style="font-weight: bold; color: #9c27b0; font-size: 0.9rem; text-transform: uppercase;" id="statusDisplay">
            STATUS: {{ match.state|upper|replace('_', ' ') }}
        </div>
    </div>

    {% if (current_user.is_admin or current_user.is_mod) and match.state == 'waiting_for_ready' %}
    <div class="card" style="border-left: 5px solid #2196f3; margin-bottom: 20px;">
        <h3 style="color: #2196f3; margin-top: 0;">üó∫Ô∏è Admin: Maps festlegen</h3>
        <form method="POST">
            <input type="hidden" name="set_maps" value="true">
            <div class="admin-grid">
                {% for i in range(1, 4) %}
                <div>
                    <label style="display:block; margin-bottom:5px; color:#aaa; font-size:0.9rem;">Karte {{ i }}</label>
                    <select name="map_{{ i }}" style="width: 100%; padding: 12px; background: #333; color: white; border: 1px solid #555; border-radius: 4px;">
                        {% for map in all_maps %}
                            <option value="{{ map.name }}">{{ map.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}
            </div>
            <button class="btn" style="width: 100%; background: #2196f3; margin-top: 20px; padding: 12px;">Karten speichern</button>
        </form>
    </div>
    {% endif %}

    {% if picked %}
    <div class="card" style="margin-bottom: 20px;">
        <h4 style="margin-top: 0; margin-bottom: 15px;">üèüÔ∏è Map Pool</h4>
        <div class="map-container">
            {% for m_name in picked %}
                {% set map_obj = all_maps | selectattr('name', 'equalto', m_name) | first %}
                <div class="map-box">
                    {% if map_obj %}
                        <img src="{{ url_for('static', filename='map_images/' + map_obj.image_file) }}" class="map-img">
                    {% endif %}
                    <div class="map-title">{{ loop.index }}. {{ m_name }}</div>
                </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if match.state in ['waiting_for_code', 'in_progress', 'finished'] %}
    <div class="card" style="text-align: center; border: 2px solid #ff9800; margin-bottom: 20px;">
        <h3 style="margin-bottom: 5px;">üîë LOBBY CODE</h3>
        
        <div id="lobbyCodeDisplay" style="font-size: 2rem; letter-spacing: 3px; font-weight: bold; color: #ff9800; margin: 10px 0; background: #222; padding: 10px; border-radius: 8px; word-break: break-all;">
            {% if match.lobby_code %}{{ match.lobby_code }}{% else %}...{% endif %}
        </div>
        
        {% if current_user.is_admin or current_user.is_mod %}
            <form method="POST" class="lobby-form" style="margin-top: 15px; display: flex; justify-content: center; gap: 10px;">
                <input type="text" name="lobby_code" placeholder="Code eingeben" value="{{ match.lobby_code or '' }}" 
                       style="padding: 12px; background: #222; border: 1px solid #555; color: white; width: 200px; border-radius: 4px;">
                <button name="set_lobby_code" class="btn-small" style="padding: 12px 20px; background: #ff9800; color: black; font-weight: bold;">Setzen & Start</button>
            </form>
        {% else %}
            {% if not match.lobby_code %}<div style="color: #aaa; font-style: italic;">Warte auf Admin...</div>{% endif %}
        {% endif %}
    </div>
    {% endif %}

    {% if (current_user.is_admin or current_user.is_mod) and match.state in ['in_progress', 'finished'] %}
    <div class="card" style="border-left: 5px solid #f44336; margin-bottom: 20px;">
        <h3 style="color: #f44336; margin-top: 0;">üëÆ Ergebnisse</h3>
        <form method="POST">
            <input type="hidden" name="submit_scores" value="true">
            
            <div style="overflow-x: auto; margin-bottom: 15px;">
                <table style="width: 100%; border-collapse: collapse; min-width: 300px;">
                    <thead>
                        <tr style="border-bottom: 1px solid #555;">
                            <th style="text-align: left; padding: 10px;">Map</th>
                            <th style="text-align: center;">
                                {{ match.team_a }}
                                {% if match.team_a_clan %}<br><small style="color:#888; font-weight:normal;">({{ match.team_a_clan }})</small>{% endif %}
                            </th>
                            <th style="text-align: center;">
                                {{ match.team_b }}
                                {% if match.team_b_clan %}<br><small style="color:#888; font-weight:normal;">({{ match.team_b_clan }})</small>{% endif %}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set saved_a = match.get_scores_a() %}
                        {% set saved_b = match.get_scores_b() %}
                        {% for i in range(1, 4) %}
                        <tr style="border-bottom: 1px solid #333;">
                            <td style="padding: 10px; vertical-align: middle;">
                                <span style="color:#888; font-size: 0.8rem;">Runde {{ i }}</span><br>
                                {% if picked and picked|length >= i %}<strong>{{ picked[i-1] }}</strong>{% endif %}
                            </td>
                            <td style="text-align: center; vertical-align: middle;">
                                <input type="number" name="score_a_{{i}}" style="width: 50px; text-align: center; padding: 10px; background: #222; color: white; border: 1px solid #555; border-radius: 4px;" 
                                       value="{{ saved_a[i-1] if saved_a|length >= i else 0 }}">
                            </td>
                            <td style="text-align: center; vertical-align: middle;">
                                <input type="number" name="score_b_{{i}}" style="width: 50px; text-align: center; padding: 10px; background: #222; color: white; border: 1px solid #555; border-radius: 4px;" 
                                       value="{{ saved_b[i-1] if saved_b|length >= i else 0 }}">
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <button class="btn" style="width: 100%; background: #f44336; padding: 12px;">Ergebnisse Speichern & Beenden</button>
        </form>
    </div>
    {% endif %}

    <div class="chat-container">
        <div style="padding: 10px 15px; border-bottom: 1px solid #333; font-weight: bold; background: #252525; display: flex; justify-content: space-between; align-items: center;">
            <span>üí¨ Match Chat</span>
            <span style="font-size: 0.8rem; color: #888;">Live</span>
        </div>
        
        <div id="chatBox" class="chat-messages">
            <div style="text-align: center; color: #555; margin-top: 20px;">Lade Chat...</div>
        </div>
        
        <div style="padding: 10px; border-top: 1px solid #333; display: flex; gap: 10px; background: #222;">
            <input type="text" id="msgInput" style="flex: 1; padding: 12px; background: #111; border: 1px solid #444; color: white; border-radius: 20px;" placeholder="Nachricht..." onkeypress="handleEnter(event)">
            <button onclick="sendMsg()" class="btn-small" style="background: #4caf50; border-radius: 50%; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; padding: 0;">‚û§</button>
        </div>
    </div>

</div>

<script>
    const matchId = {{ match.id }};
    const currentUser = "{{ current_user.username }}";
    
    const chatBox = document.getElementById('chatBox');
    const lobbyDisplay = document.getElementById('lobbyCodeDisplay');
    const statusDisplay = document.getElementById('statusDisplay');
    let lastMsgCount = 0;

    async function updateState() {
        try {
            const res = await fetch(`/api/cup_match/${matchId}/state`);
            const data = await res.json();
            
            statusDisplay.innerText = "STATUS: " + data.state.toUpperCase().replace('_', ' ');
            
            if (lobbyDisplay) {
                lobbyDisplay.innerText = data.lobby_code ? data.lobby_code : (data.state === 'waiting_for_code' ? "Admin legt Code fest..." : "...");
            }

            // Auto-Reload bei Status√§nderung
            const currentStateFromTemplate = "{{ match.state }}";
            if (!window.lastKnownState) window.lastKnownState = currentStateFromTemplate;

            if (data.state !== window.lastKnownState) {
                window.location.reload();
            }
            window.lastKnownState = data.state;

        } catch (e) { console.log("Polling error:", e); }
    }

    async function sendMsg() {
        const txt = document.getElementById('msgInput').value;
        if(!txt) return;
        
        await fetch(`/api/cup_match/${matchId}/chat`, { 
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify({message: txt}) 
        });
        document.getElementById('msgInput').value = ''; 
        loadChat();
    }

    function handleEnter(e) { if(e.key === 'Enter') sendMsg(); }

    async function loadChat() {
        try {
            const res = await fetch(`/api/cup_match/${matchId}/chat`);
            const data = await res.json();
            
            if (data.length !== lastMsgCount) {
                chatBox.innerHTML = data.map(m => {
                    let badge = '';
                    let color = '#333'; 
                    let align = m.is_me ? 'right' : 'left';
                    let bg = m.is_me ? '#1976d2' : '#333';
                    
                    if (m.is_admin) { badge = 'üõ°Ô∏è '; bg = '#e65100'; } 
                    else if (m.is_mod) { badge = 'üõ°Ô∏è '; bg = '#00bcd4'; } 

                    return `<div style="margin-bottom: 8px; text-align: ${align}">
                        <span class="msg-meta">${badge}${m.user}</span>
                        <div style="background: ${bg}; padding: 8px 12px; border-radius: 8px; display: inline-block; color: white; max-width: 85%; word-wrap: break-word; text-align: left;">
                            ${m.text}
                        </div>
                    </div>`;
                }).join('');
                
                chatBox.scrollTop = chatBox.scrollHeight;
                lastMsgCount = data.length;
            }
        } catch(e) {}
    }

    setInterval(() => { updateState(); loadChat(); }, 3000);
    updateState(); loadChat();
</script>
{% endblock %}